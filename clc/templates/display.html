{% extends "base.html" %}
{% load i18n %}
{% block content %}
{% if not mine %}
<a class="back-button" href="/">{% trans "Back to my list" %}</a>
	{% if not friend %}
	<button class="add-friend-button">{% trans "Add to my friends" %}</button>
	{% endif %}
{% else %}
{% endif %}
<div class="header">{{ header }}</div>
<div id="challenges">
{% for c in challenges %}
	{% if forloop.first %}
		<div class="row table_head">
			<span class="cell description">{% trans "Description" %}</span>
			<span class="cell category">{% trans "Category" %}</span>
			<span class="cell progress">{% trans "Progress" %}</span>
		</div>
	{% endif %}
	<div class="row" id="challenge-row-{{ c.id }}" style="background-color:rgb({{c.category.red}},{{c.category.green}},{{c.category.blue}});">
		<span class="cell description">{{ c.description }}</span>
		<span class="cell category">{{ c.category.name }}</span>
		{% if mine %}
		<span class="cell progress-slider-cell">
			<div id="progress-{{ c.id }}" class="progress-slider" value="{{ c.progress }}"></div>
		{% else %}
		<span class="cell progress-bar-cell">
			<div id="progress-{{ c.id }}" class="progress-bar" value="{{ c.progress }}"></div>
		{% endif %}
		</span>
		<span class="cell action">
			{% if mine %}<button class="delete-challenge-button" id="delete-{{ c.id }}">{% trans "Delete" %}</button>
			{% else %}{% if logged_in %}<button class="grab-button" id="grab-{{ c.id }}">{% trans "Accept this challenge" %}</button>
			{% else %}<button class="logme-button" id="logme-{{ c.id }}">{% trans "Add this to YOUR list" %}</button>{% endif %}{% endif %}
		</span>
	</div>
{% empty %}
{% trans "No challenge yet. You can now create a challenge. Just dodo it!" %}
{% endfor %}
</div>
<br /><br />
<script src="http://connect.facebook.net/{% trans "en_US" %}/all.js#xfbml=1"></script><fb:like href="" show_faces="true" width="450" font=""></fb:like>
<br /><br />
<br /><br />
{% if mine %}
<div class="header">{% trans "Add a new challenge" %}</div>
<form id="add-challenge-form" action="/add" method="post">{% csrf_token %}
<table>
<tr>
{% for field in challenge_form.visible_fields %}
	<th>{{ field.label_tag }}</th>
{% endfor %}
	<th></th>
</tr>
<tr>
{% for field in challenge_form.visible_fields %}
	<td>{{ field }}</td>
{% endfor %}
	<td><input type="submit" value="{% trans "Add" %}" id="add-challenge"/></td>
</tr>
</table>
{% for hidden in challenge_form.hidden_fields %}
{{ hidden }}
{% endfor %}
</form>
<br /><br />

{% if friends %}
<div class="header">{% trans "Your friends" %}</div>
<div id="friends">
{% for f in friends %}
	{% if forloop.first %}
		<div class="row table_head">
			<span class="cell name">{% trans "Name" %}</span>
			<span class="cell color">{% trans "Action" %}</span>
		</div>
	{% endif %}
	<div class="row {% cycle "even" "odd" %}" id="friend-row-{{ f.id }}">
		<span class="cell name"><a href="/{{ f.name }}">{{ f.name }}</a></span>
		<span class="cell action">
			<button class="delete-friend-button" id="delete-friend-{{ f.id }}">{% trans "Delete" %}</button>
		</span>
	</div>
{% endfor %}
</div>
<br /><br />
{% endif %}
{% if categories %}
<div class="header">{% trans "Your categories" %}</div>
<div id="categories">
{% for c in categories %}
	{% if forloop.first %}
		<div class="row table_head">
			<span class="cell name">{% trans "Name" %}</span>
			<span class="cell color">{% trans "Action" %}</span>
		</div>
	{% endif %}
	<div class="row {% cycle "even" "odd" %}" id="category-row-{{ c.id }}" style="background-color:rgb({{c.red}},{{c.green}},{{c.blue}});">
		<span class="cell name">{{ c.name }}</span>
		<span class="cell action">
			<button class="delete-category-button" id="delete-{{ c.id }}">{% trans "Delete" %}</button>
		</span>
	</div>
{% endfor %}
</div>
<br /><br />
{% endif %}

<div class="header">{% trans "Add a new category" %}</div>
<form id="add-category-form" action="/add" method="post">{% csrf_token %}
<table>
{% for field in category_form.visible_fields %}
<tr>
	<th>{{ field.label_tag }}</th>
	<td>{{ field }}</td>
</tr>
{% endfor %}
<tr>
	<th>{% trans "Color" %}</th>
	<td><div id="red"></div>
		<div id="green"></div>
		<div id="blue"></div>
		<div id="swatch" class="ui-widget-content ui-corner-all"></div>
	</td>
</tr>
<tr>
{% for field in category_form.visible_fields %}
{% endfor %}
	<td><input type="submit" value="{% trans "Add" %}" id="add-category"/></td>
</tr>
</table>
{% for hidden in category_form.hidden_fields %}
{{ hidden }}
{% endfor %}
</form>
{% else %}
<a class="back-button" href="/">{% trans "Back to my list" %}</a>
{% endif %}

<script type="text/javascript">
function checkCompleted(t){
		if ($(t).slider("value") == 100) {
			$(t).children(".ui-slider-range").css("background", "#88FF88");
			$(t).children(".ui-slider-handle").css("border-color", "#88FF88");
		}
		else {
			$(t).children(".ui-slider-range").css("background", "");
			$(t).children(".ui-slider-handle").css("border-color", "");
		}
};
function hexFromRGB(r, g, b) {
	var hex = [
		r.toString( 16 ),
		g.toString( 16 ),
		b.toString( 16 )
	];
	$.each( hex, function( nr, val ) {
		if ( val.length === 1 ) {
			hex[ nr ] = "0" + val;
		}
	});
	return hex.join( "" ).toUpperCase();
}
function refreshSwatch() {
	var red = $( "#red" ).slider( "value" ),
		green = $( "#green" ).slider( "value" ),
		blue = $( "#blue" ).slider( "value" ),
		hex = hexFromRGB( red, green, blue );
	$( "#swatch" ).css( "background-color", "#" + hex );
}

$(function(){
	$("#add-challenge").button();
	$("#add-challenge-form").submit(function(){
		$.post(
			"/add", 
			$(this).serialize(), 
			function(){location.reload();}
		);
		return false;
	});
	$("#add-category").button();
	$("#add-category-form").submit(function(){
		$.post(
			"/add", 
			{
				"hidden":"category",
				"name":$("#id_name").attr( "value" ),
				"red":$( "#red" ).slider( "value" ),
				"green":$( "#green" ).slider( "value" ),
				"blue":$( "#blue" ).slider( "value" )
			},
			function(){location.reload();}
		);
		return false;
	});
	$(".back-button").button({
		icons: {
			primary: "ui-icon-arrowthick-1-w",
			secondary: "ui-icon-script"
		}
	});
	$(".logout-button").button({
		icons: {
			primary: "ui-icon-power",
		}
	});
	$(".delete-challenge-button").button({
		icons: {
			primary: "ui-icon-trash"
		}
	}).click(function() {
		$.post(
			"/delete", 
			{"challenge": this.id.split('-').pop()}, 
			function(data){
				$("#challenge-row-"+data).animate({opacity:0}, 250).animate({height:0},250, function(){$("#challenge-row-"+data).remove();});
			}
		);
	});
	$(".delete-category-button").button({
		icons: {
			primary: "ui-icon-trash"
		}
	}).click(function() {
		$.post(
			"/delete", 
			{"category": this.id.split('-').pop()}, 
			function(data){
				$("#category-row-"+data).animate({opacity:0},250).animate({height:0},250, function(){$("#category-row-"+data).remove();});
			}
		);
	});
	$(".delete-friend-button").button({
		icons: {
			primary: "ui-icon-trash"
		}
	}).click(function() {
		$.post(
			"/delete", 
			{"friend": this.id.split('-').pop()}, 
			function(data){
				$("#friend-row-"+data).animate({opacity:0},250).animate({height:0},250, function(){$("#friend-row-"+data).remove();});
			}
		);
	});
	$(".logme-button").button({
		icons: {
			primary: "ui-icon-lightbulb"
		}
	}).click(function(){
		window.location = "/?next="+window.location;
	});
	$(".add-friend-button").button({
		icons: {
			primary: "ui-icon-plus"
		}
	}).click(function() {
		$.post(
			"/add", 
			{
				"hidden":"friend",
				"name":"{{ list_name }}"
			},
			function(data){
				if (data == "ok"){
					$(".add-friend-button").fadeOut(250, function(){$(this).remove();});
				}
			}
		);
		return false;
	});
	$(".grab-button").button({
		icons: {
			primary: "ui-icon-lightbulb"
		}
	}).click(function() {
		$.post(
			"/add", 
			{"challenge": this.id.split('-').pop()}, 
			function(data){
				$("#challenge-row-"+data).fadeOut(500).fadeIn(500);
			}
		);
	});
	$(".progress-slider").each(function(){
		$(this).slider({
			orientation: "horizontal",
			range: "min",
			max: 100,
			value: $(this).attr("value"),
			step: 5,
			stop: function( event, ui){
				checkCompleted(this);
				$.post(
					"/save", 
					{"challenge": this.id.split("-").pop(), "progress": $(this).slider("value")} 
				);
			}
		});
		checkCompleted(this);
	});
	$(".progress-bar").each(function(index, item){
		$(this).progressbar({
			value: parseInt($(item).attr("value")),
		});
	});
	$( "#red, #green, #blue" ).slider({
		orientation: "horizontal",
		range: "min",
		max: 255,
		value: 127,
		slide: refreshSwatch,
		change: refreshSwatch
	});
	$( "#red" ).slider( "value", 255 );
	$( "#green" ).slider( "value", 140 );
	$( "#blue" ).slider( "value", 60 );

});
</script>
{% endblock content %}
